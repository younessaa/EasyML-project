import React, { useState,useEffect } from "react";
import { Redirect } from "react-router-dom";
import axios from "axios";
import "./Exploite.css";
import { useParams } from "react-router-dom";
import { useSelector } from "react-redux";
import { useDispatch } from "react-redux";
import { getExploitables } from '../../actions/exploitables';

var fileDownload = require('js-file-download');

function Exploite() {
  const { tocken } = useParams();
  const dispatch = useDispatch();
    useEffect(() => {
        dispatch(getExploitables());
    }, [dispatch]);
  const exploitable = useSelector((state) =>(state.exploitables.find(exploitable => exploitable.tocken===tocken) ));
  console.log(exploitable)
  const [modeltocken,setmodeltaken] = useState();
  const [file,setFile] = useState();
  
  const onChange=e =>{
    setFile(e.target.files[0])
  }
  const download = (e) => {
    setmodeltaken(tocken);
    console.log(tocken)
    axios({
      url:"//localhost:5000/downloadmodel/"+tocken,
      method:"GET",
      responseType:"blob"
    }).then((res)=>{
      fileDownload(res.data,'model.pickle')
    })
  }
    
  const onSubmit = (e) => {
    setmodeltaken(tocken);
    console.log(modeltocken)
    e.preventDefault();
    var data=new FormData();
    data.append('file',file);

    const url="//localhost:5000/predict/"+modeltocken;
    axios.post(url, data , {headers: {"Content-Type": "multipart/form-data"}},{ responseType: 'blob' })
          .then((res) => {
              fileDownload(res.data,'predictions.csv')
          })
          .catch((e) => {
          })
};
    
  return (
    <>
    <br></br>
    <h1 className="modeln"></h1>
    <br></br>
    <br></br>
    <div className="containere">
      <div className="rowe" >
      <br></br>
      <div></div>
      <br></br>
      <label >exploitable's tocken : {tocken}</label>

      </div>
      <div className="rowe">
        <label className="useas" >Use as a PYTHON Dev</label>
        <br></br>
        <br></br>
        <button  className="download" type="button" onClick={(e)=>download(e)}>Download the model (.pickle)</button>
      </div>
      <div className="rowe">
        <label className="useas" >Use as an API client</label>
        <br></br>
        <br></br>
        <div className="curl"> <label> CURL : 
        &gt;&gt; curl --location --request POST 'http://localhost:5000/predict/{tocken}' --form 'file=@"path of .csv you want to predict"'</label><br></br>
      </div></div>
      <div className="rowe">
        <label className="useas" >Use Right NOW!!</label>
        <form onSubmit={onSubmit}>
          <div  >
            <br></br>
            <label className="useas" id="smaller" > Features : </label>
            <input className="useas" id="smaller" type="file" accept=".csv" onChange={onChange}></input>
            <br></br>
            
          </div>
          <br></br>
          <button className="download" type="submit" >PREDICT !!</button>
        </form>
        <br></br>
        <br></br>
      </div>
    </div>
    </>
        
  );
}
export default Exploite;